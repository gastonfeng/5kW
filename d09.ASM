; THIS IS SPWM TEST PROGRAM===ZW168.ASM
	

	        .INCLUDE   "INIT13.H"
        	.INCLUDE   "PWM.H"
		.INCLUDE   "PWMSUB42.H"
		.INCLUDE   "SHOW7.H"	;加入LCD显示的通用子程序和变量定义


                .SECT   ".VEC"
RSVECT		B	START
INT1            B       INT1_ISR
INT2            B       LOADCOUNT
INT3            B       DD
INT4		B	CAP1
         
		.BSS	DIVID1,1	;被除数
		.BSS	DIVID2,1	;除数
		.BSS	DIVRESULT1,1	;商
		.BSS	DIVRESULT2,1	;余数
		.BSS	MPY1,1
		.BSS	MPY2,1
		.BSS	MPYRESULT,1
	       	.BSS   	PWMADDRESS,1	;SIN表的数据地址
		.BSS	SPWMADDRESS,1
		.BSS	PWMADDRESS1,1
		.BSS	SPWM1,1
		.BSS	SPWM2,1
		.BSS	ADCALU1,1
		.BSS	ADCALU2,1
		.BSS	ADCALU3,1
	       	.BSS	PWMCOUNT1,1	;first pulse position count
		.BSS	PWMCOUNT2,1
		.BSS	PWMCOUNT3,1
		.BSS	PWMADD,1	;EVERY PWM PULSE ADD VALUE=T/4;WHEN T=20/150MS  PWMADD=666
		.BSS	ADRESULT,1		;A/D GENERAL RESULT
		.BSS	ADDATA,1		;A/D AVERAGE DATA
		.BSS	ADDATA1,1
		.BSS	ADDATA2,1
		.BSS	ADDATA3,1
		.BSS	ADDATA4,1
		.BSS	ADDATA5,1
		.BSS	ADJUDGE1,1
		.BSS	ADJUDGE2,1
		.BSS	ADJUDGE3,1
		.BSS	ADJUDGE4,1
		.BSS	ADJUDGE5,1
		.BSS	NEWCAMP1,1		;1,3 PHASE NEW CAMP DATA
		.BSS	NEWCAMP7,1
		.BSS	NEWCAMP11,1
		.BSS	NEWCAMP2,1		;2,4 PHASE NEW CAMP DATA
		.BSS	NEWCAMP21,1
		.BSS	NEWCAMP,1
		.BSS	NEWCAMP3,1
		.BSS	NEWCAMPT1,1
		.BSS	NEWCAMPT2,1
		.BSS	NEWCAMPT3,1
		.BSS	SLOW1,1			;USED TO SOFT BEGIN
		.BSS	SLOW2,1
		.BSS	SLOW3,1		
		.BSS	ADVALUE,1		;USED TO STORE THE 1/2 THE TRUE VALUE
		.BSS	CMPR1TEMP,1
		.BSS	CMPR2TEMP,1
		.BSS	CMPR1TMEP1,1
		.BSS	CMPR2TEMP1,1
		.BSS	T2TEMP,1
		.BSS	ADVALUE1,1
		.BSS	ADVALUE2,1
		.BSS	CAPTEMP1,1
		.BSS	CAPTEMP2,1
		.BSS	CAPTEMP3,1
		.BSS	CAPTEMP4,1
		.BSS	CAPTEMP5,1
		.BSS	FDATA1,1
		.BSS	FDATA2,1
		.BSS	FDATA3,1
		.BSS	FDATA4,1

		.BSS	WDATA1,1
		.BSS	WDATA2,1
		.BSS	WDATA3,1
		.BSS	WDATA4,1
		.BSS	WDATA5,1
		.BSS	WDATA6,1
		.BSS	WDATA7,1
		.BSS	WDATA8,1
		.BSS	PWMK1,1
		.BSS	PWMK2,1
STK1		.usect "B2", 1
STK2 		.usect "B2", 1
STK3 		.usect "B2", 1
STK4 		.usect "B2", 1
		.BSS	VDATA1,1
		.BSS	VDATA38,1
		.BSS	LIMIT1,1
		.BSS	SDATA1,1
		.BSS	SDATA2,1
		.BSS	SDATA5,1
		.BSS	PWMAD1,1
		.BSS	PWMAD2,1
		.BSS	PWMAD,1
		.BSS	TDATA1,1
		.BSS	TDATA2,1
		.BSS	TDATA3,1
		.BSS	TDATA4,1
		.BSS	TDATA5,1
		.BSS	TDATA6,1
		.BSS	TDATA7,1
		.BSS	TDATA8,1
		.BSS	PWMM1,1
		.BSS	U2AD1,1
		.BSS	U2K1,1
		.BSS	U2K2,1
		.BSS	SETCURRENT,1
		.BSS	ADK1,1
		.BSS	ADK2,1
		.BSS	SETCURRENT1,1
		.BSS	AD1MID,1		;AC VOL  AD BASE
		.BSS	AD2MID,1		;AC CUR  AD BASE
LENGTH1 .SET    00007H
LENGTH2	.SET	00016H
LENGTH3	.SET	0001Bh
LENGTH4 .SET	00020H
B2_SADDR.SET    00060H
B0_SADDR.SET    00200H
B1_SADDR.SET	00300H
	.BSS	GPR0,1
	.BSS	VALUE1,1
	.BSS	VALUE11,1
	.BSS	VALUE12,1
	.BSS	VALUE13,1
	.BSS	VALUE14,1
	.BSS	VALUE15,1
	.BSS	COUNT1,1
	.BSS	KEYTEMP1,1		;按键防抖动计数器
	.BSS	KEYTEMP3,1		;设定记数器
	.BSS	KEYTEMP4,1		;设定位置计数器
KEYTEMP2	.SET	400		;防抖动常数
	.BSS	KEYMODE,1		;按键状态标志
	.BSS	SHOWMODE,1		;显示的状态标志	
		.BSS	OUTDATA,1		;显示输出数据，用于显示初始化
		.BSS	SHOWCOM,1		;子程序中的显示命令
		.BSS	SHOWDAT,1		;子程序中的显示数据
		.BSS	SHOWTEMP1,1		;页面地址暂存器
SHOWPD1		.SET	0032H			;液晶常量定义
		.BSS	SHOWTEMP2,1		;字符字模块首地址
		.BSS	SHOWCOLUMN,1		;LCD列地址
		.BSS	SHOWPAGE,1		;LCD页地址
		.BSS	SHOWCODE,1		;字符代码寄存器
		.BSS	SHOWCOUNT1,1		;显示计数器
		.BSS	SHOWTEMP3,1		;辅助地址寄存器
		.BSS	KEYTEMP31,1
		.BSS	KEYTEMP32,1
		.BSS	RUNTAG,1		;启动运行标志
		.BSS	STOPTAG,1		;停止运行标志
		.BSS	SETTAG,1		;设定标志
		.BSS	SETCOUNT1,1		;设定的输出电流值

		

	.TEXT
	NOP
START:	SETC  	INTM
	CLRC	SXM
	CLRC	OVM
	CLRC	CNF
	LDP	#00E0H
	SPLK	#006FH,WDCR
        NOP
	KICK_DOG


	LDP     #0
	NOP
        SPLK    #000BH,IMR	;ENABLE INT4 AND INT2 AND INT1
	NOP
        LACC    IFR
	NOP
	NOP
        SACL    IFR
	NOP
	NOP


	LDP	#00E1H
	SPLK	#00H,OCRA
	SPLK	#010H,OCRB
	SPLK	#04040H,PCDATDIR

	LACC	PBDATDIR
	AND	#1011100011111111B		;将PB.0(DOWN) and  PB.1(^) and PB.2(RUN) PB.6(STOP)  set for input
	SACL	PBDATDIR

	LACC	PADATDIR
	AND	#1111001111111111B		;将PA.2(SET) and  PA.3(>)  set for input
	SACL	PADATDIR

	LDP	#4
	SPLK	#0,KEYMODE			;init the keymode=00h
	SPLK	#0,KEYTEMP3			;INIT THE KEYTEMP3=0H	
	SPLK	#0,KEYTEMP4			;INIT THE KEYTEMP4=0H

	LDP	#0E0H	
	SPLK 	#0000000001100000b,CKCR1
	SPLK 	#0000000000000001b,CKCR0; Disable PLL
	NOP
	NOP
	SPLK 	#0000000011000001b,CKCR0; Re-enable PLL

	LDP	#224
	NOP
	NOP
	SPLK	#00H,XINT3CR

	LACC	XINT3CR


	LDP	#0E0H
	SPLK	#05H,SPIPC1		;FAN INIT


;INIT OF INTERRUPT DRIVEN SCI ROUTINE
SCI_INIT:	LDP	#00E0H
		SPLK	#0037H,SCICCR
		SPLK	#0013H,SCICTL1
		SPLK	#0002H,SCICTL2
		SPLK    #0000H,SCIHBAUD
 		SPLK    #0040H,SCILBAUD ;RATE=19200B/S
		SPLK    #0022H,SCIPC2
		SPLK	#003BH,SCICTL1
		LAR	AR0,#SCITXBUF
		LAR	AR1,#SCIRXBUF
		LAR   	AR2,#B1_SADDR 	;Load AR2 with TX data start address
 		LAR 	AR3,#B0_SADDR


;--------------------------------------------------------------------
;	PWM INIT
;--------------------------------------------------------------------
	
	
	LDP	#4
	SPLK	#666,PWMADD

	SPLK	#0,ADVALUE
;-----------------------------------
; Set up PWM Module
;-----------------------------------
	LDP     #232
	NOP
	NOP
	SPLK	#03H,T2CNT
	SPLK	#0FFFFH,T2PR
	SPLK	#07FFFH,T2CMPR	;20MS =30D4H(1/32 CPUCLK)
	NOP
	NOP
	SPLK    #1001010101000000B,T2CON

	NOP

	SPLK	#1010000010000000B,CAPCON
	
;		 5432109876543210       
;        SPLK	#0000011001100110B,ACTR		
	SPLK	#0000111111111111B,ACTR
	NOP
	NOP
        SPLK    #1110000000101010B,GPTCON
	NOP
	NOP
	SPLK	#0000010111111000B,DBTCON	;使用了X/8的CPU时钟频率
	NOP
	NOP
	SPLK	#0535H,T1PR
	NOP
	NOP
	SPLK    #0081H,EVIMRA			;enable the int of cmpr1 and pdpint.
	SPLK	#0001B,EVIMRC
	SPLK	#0010H,EVIMRB
	NOP
        SPLK    #0A802H,T1CON
	NOP
	NOP
	NOP
        SPLK    #0A842H,T1CON
	NOP
	LDP	#4
	NOP
	NOP
        SPLK    #0,PWMCOUNT1
	NOP
	NOP

	SPLK	#103,PWMCOUNT3
	NOP
	NOP
	NOP
	SPLK	#142,PWMCOUNT2

	SPLK	#SINWAVE,PWMADDRESS
	NOP
	NOP
	SPLK	#SINWAVE1,PWMADDRESS1	
	NOP
	NOP
	LDP	#232
	NOP
;		 5432109876543210  
        SPLK    #0000100001010111B,COMCON
	NOP
	NOP
	NOP
;        SPLK    #1100101001010111B,COMCON
	NOP
	NOP
	NOP
	NOP
	LDP	#232
	NOP
	LACC	EVIFRA
	NOP
	NOP
	SACL	EVIFRA
	NOP
	LACC	EVIFRB
	NOP
	SACL	EVIFRB
	NOP
	LACC	EVIFRC
	NOP
	SACL	EVIFRC
	NOP



	CALL	SHOWINT			;调用初始化子程序
	CALL	CLEAR
	CALL	CLEAR
	CALL    STOP_SHOW		;调用停止状态显示子程序





	LDP	#4
	SPLK	#SINWAVE,PWMADDRESS
	SPLK	#16,SLOW1
	SPLK	#0,SLOW2
	SPLK	#0,SLOW3
	SPLK	#0,ADVALUE1
	SPLK	#0,ADVALUE2
	SPLK	#0,FDATA1
	SPLK	#0,FDATA2
	SPLK	#0,FDATA3
	SPLK	#0,FDATA4
	SPLK	#0,WDATA1
	SPLK	#0,WDATA2
	SPLK	#0,WDATA3
	SPLK	#0,WDATA4
	SPLK	#0,WDATA5	
	SPLK	#0,WDATA6
	SPLK	#0,WDATA7
	SPLK	#0,WDATA8
	SPLK	#0,ADDATA1
	SPLK	#0,ADDATA2
	SPLK	#0,ADDATA3
	SPLK	#0,ADDATA4
	SPLK	#0,ADDATA5

	SPLK	#01H,PWMK1

	SPLK	#0100H,PWMK2

	SPLK	#23,PWMM1


	
	SPLK	#0,SPWM2

	SPLK	#0,ADCALU1
	SPLK	#0,ADCALU2
	SPLK	#0,ADCALU3	
	SPLK	#0,ADJUDGE1
	SPLK	#0,ADJUDGE2
	SPLK	#0,ADJUDGE3
	SPLK	#0,ADJUDGE4
	SPLK	#0,ADJUDGE5
	SPLK	#100,NEWCAMP11
	SPLK	#0,LIMIT1
	SPLK	#4,SDATA1
	SPLK	#0,SDATA2
	SPLK	#0,SDATA5
	SPLK	#0,PWMAD1
	SPLK	#0,PWMAD2
	SPLK	#0,PWMAD
	SPLK	#0,TDATA1
	SPLK	#0,TDATA2
	SPLK	#0,TDATA3
	SPLK	#0,TDATA4
	SPLK	#0,TDATA5
	SPLK	#0,TDATA6
	SPLK	#0,TDATA7
	SPLK	#0,TDATA8

	SPLK	#0,U2AD1

	SPLK	#22,U2K1

	
	SPLK	#0,SETCURRENT1

	SPLK	#0,NEWCAMP2
	SPLK	#0,NEWCAMP21
	SPLK	#45,ADK1
	
	SPLK	#504,AD1MID
	SPLK	#513,AD2MID	

	SPLK	#0,NEWCAMP7
	SPLK	#0,NEWCAMP3

	SPLK	#0,NEWCAMPT1

	SPLK	#0,RUNTAG
	SPLK	#1,STOPTAG
	SPLK	#0,SETTAG
	SPLK	#0,SETCOUNT1

	SPLK	#0,KEYTEMP31
	SPLK	#0,KEYTEMP32

	SPLK	#6,SPWM1	
	
	CLRC	INTM


LOOP:	NOP
	NOP
	NOP
	CALL	KEYPRESS
        NOP
        NOP
	B       LOOP

	.END
